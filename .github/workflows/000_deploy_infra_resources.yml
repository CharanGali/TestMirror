name: 000 deploy infra

env:
  AZ_CLI_VERSION: 2.30.0

on:
  workflow_dispatch:
    inputs:
      subscription_code:
        description: "SUBSCRIPTION_CODE of resources to be deployed. This value is also used as the github secret env value. (e.g. gcspre, gcsrls):"
        required: true
        default: gcspre
      region_code:
        description: "REGION_CODE of resources to be deployed (e.g. japaneast):"
        required: true
        default: japaneast
      env_name:
        description: "ENV_NAME of resources to be deployed (e.g. prd, sdv, dev):"
        required: true
        default: dev
      app_code:
        description: "APP_CODE of resources to be deployed (usually do not need to change from lacmn):"
        required: true
        default: lacmn
      st_rg_name:
        description: "[RESTORE] RG name of the backup Storage Account.
          (e.g. rg-gcspre-cmn-lacmn-st-blob-agw-backup):"
        required: false
        default: ""
      restore_file_name:
        description: "[RESTORE] File name to be restored.
          (e.g. ARMBK{YYYYmmddHHMMSS}-{AGW_RG_NAME}.json; [default: latest]):"
        required: false
        default: ""
      force_update_flag:
        type: boolean
        description: "When building AGW, do you forcibly process even if RG already exists? "
        required: false
        default: "false"

jobs:
  main:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.subscription_code }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@master
        with:
          fetch-depth: 0

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: STEP 000
        uses: azure/CLI@v1
        with:
          azcliversion: ${{ env.AZ_CLI_VERSION }}
          inlineScript: |
            ./azure/deployments/000-deploy-lacmn-key-vault.sh \
              "${{ github.event.inputs.env_name }}" \
              "${{ github.event.inputs.region_code }}" \
              "${{ github.event.inputs.subscription_code }}" \
              "${{ github.event.inputs.app_code }}"

      - name: STEP 001
        uses: azure/CLI@v1
        with:
          azcliversion: ${{ env.AZ_CLI_VERSION }}
          inlineScript: |
            ./azure/deployments/001-deploy-sql-secret-settings.sh \
              "${{ github.event.inputs.subscription_code }}" \
              "${{ github.event.inputs.region_code }}" \
              "${{ github.event.inputs.env_name }}" \
              "${{ github.event.inputs.app_code }}"

      - name: STEP 002
        uses: azure/CLI@v1
        with:
          azcliversion: ${{ env.AZ_CLI_VERSION }}
          inlineScript: |
            ./azure/deployments/002-deploy-vnet-sql-cr-resources.sh \
              "${{ github.event.inputs.subscription_code }}" \
              "${{ github.event.inputs.region_code }}" \
              "${{ github.event.inputs.env_name }}" \
              "${{ github.event.inputs.app_code }}"

      - name: STEP 003
        uses: azure/CLI@v1
        with:
          azcliversion: ${{ env.AZ_CLI_VERSION }}
          inlineScript: |
            ./azure/deployments/003-deploy-github-secret-settings \
              "${{ github.event.inputs.subscription_code }}" \
              "${{ github.event.inputs.region_code }}" \
              "${{ github.event.inputs.env_name }}" \
              "${{ github.event.inputs.app_code }}"

      - name: STEP 004
        uses: azure/CLI@v1
        with:
          azcliversion: ${{ env.AZ_CLI_VERSION }}
          inlineScript: |
            ./azure/deployments/004-deploy-agw-resources.sh \
              "${{ github.event.inputs.subscription_code }}" \
              "${{ github.event.inputs.region_code }}" \
              "${{ github.event.inputs.env_name }}" \
              "${{ github.event.inputs.app_code }}" \
              "${{ github.event.inputs.st_rg_name }}" \
              "${{ github.event.inputs.restore_file_name }}" \
              "${{ github.event.inputs.force_update_flag }}"

      - name: STEP 005
        uses: azure/CLI@v1
        with:
          azcliversion: ${{ env.AZ_CLI_VERSION }}
          inlineScript: |
            ./azure/deployments/005-deploy-lacmn-app-auth-settings.sh \
              "${{ github.event.inputs.env_name }}" \
              "${{ github.event.inputs.subscription_code }}" \
              "${{ github.event.inputs.app_code }}"

      - name: STEP 006
        uses: azure/CLI@v1
        with:
          azcliversion: ${{ env.AZ_CLI_VERSION }}
          inlineScript: |
            ./azure/deployments/006-deploy-aks-resources.sh \
              "${{ github.event.inputs.env_name }}" \
              "${{ github.event.inputs.region_code }}" \
              "${{ github.event.inputs.subscription_code }}" \
              "${{ github.event.inputs.app_code }}"

      - name: Send Notification to slack
        if: always()
        uses: tokorom/action-slack-incoming-webhook@master
        env:
          INCOMING_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
            text: "***Infra Creation Completed*** [${{ github.repository }}] @ ${{ github.event_name }} "
            attachments: |
              [
                {
                  "author_name": "${{ github.actor }}",
                  "author_icon": "${{ github.event.sender.avatar_url }}",
                  "fields": [
                    {
                      "title": "GitHub Actions URL",
                      "value": "https://github.com/${{ github.repository_owner }}/${{ github.event.repository.name }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]   
